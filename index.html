<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMUDIK-Edi Brata Edition (Master S-13 & S-12)</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/edibrata/image/main/FotoEdiBrata.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; font-style: normal; }
        .tab-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 800; text-transform: uppercase; }
        .tab-btn:hover { transform: scale(1.05); }
        
        .print-page { box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius: 2px; overflow: hidden; transform-origin: top; margin-bottom: 30px; border: 1px solid #ddd; background: white; }
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(5px); }
        
        /* Restore Original Input Styles */
        input, select { border: 1px solid #cbd5e1 !important; border-radius: 8px !important; font-weight: 600; padding: 12px 16px !important; width: 100%; background: #ffffff; color: #1e293b; font-size: 14px; transition: all 0.2s; }
        input:focus, select:focus { border-color: #3b82f6 !important; ring: 2px; ring-color: #dbeafe !important; outline: none; background: #fff !important; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        label { display: block; margin-bottom: 3px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; padding-left: 2px; text-align: left; }
        
        .bg-admin-box { background: #f0f9ff; border: 1px solid #e0f2fe; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .grid-paired { display: grid; grid-template-columns: 160px 1fr; gap: 1rem; align-items: end; }
        
        /* Custom Hover Animations */
        .card-hover { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        
        @media (max-width: 1024px) { .grid-paired { grid-template-columns: 1fr; gap: 0.5rem; } }
        @media print {
            @page { size: 215mm 330mm; margin: 0; }
            body { background: none; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .print-page { box-shadow: none; border: none; margin: 0; padding: 10mm 20mm !important; width: 215mm; height: 330mm; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC6IXCk6EXm0ndord8Is6cRZf_mG2MY5UM",
            authDomain: "kedinasan-d9051.firebaseapp.com",
            projectId: "kedinasan-d9051",
            storageBucket: "kedinasan-d9051.firebasestorage.app",
            messagingSenderId: "488517479224",
            appId: "1:488517479224:web:57ed244cf69e2a010c6fcd"
        };

        const appId = "sipindah-edibrata-master-final-v15"; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const collectionName = "arsip_mutasi_master_v15_fixed";

        window.state = {
            user: null,
            isAdmin: localStorage.getItem('edibrata_v15_admin') === 'true',
            activeTab: 'dashboard',
            database: [],
            currentIndex: 0,
            searchQuery: '',
            recipientSearchQuery: '',
            globalLogo: '',
            globalSignature: '',
            signatureMode: localStorage.getItem('sipindah_sig_mode') || 'manual',
            sigOffsetX: 0,
            sigOffsetY: 0,
            sigScale: 1,
            sigRotate: 0,
            settingsExpanded: false
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if(!t) return;
            t.textContent = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        };

        window.switchTab = (tabId) => {
            window.state.activeTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId)?.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-600', 'shadow-sm');
                if (btn.dataset.tab === tabId) btn.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-600', 'shadow-sm');
            });

            if(tabId === 'produksi') window.renderRecipientView();
            if(tabId === 'database') window.renderDatabase();
            if(tabId === 'dashboard') window.updateDashboard();
            updateNavigationUI();
        };

        window.getFormHTML = () => `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-24 gap-y-12 text-left">
                <div class="space-y-10">
                    <div class="space-y-5">
                        <div class="text-blue-600 font-black text-[10px] uppercase border-b pb-1 mb-2 tracking-widest text-left">A. Identitas Sekolah Asal</div>
                        <div><label>Nama Sekolah Asal</label><input type="text" name="nama_sekolah_asal" placeholder="SD NEGERI XXXXXXXX" required class="font-bold text-left"></div>
                        <div class="grid grid-cols-2 gap-5 text-left">
                            <div><label>NPSN Asal</label><input type="text" name="npsn_sekolah_asal" placeholder="20XXXXXX"></div>
                            <div><label>Email Sekolah</label><input type="email" name="email_sekolah_asal" placeholder="contoh@sekolah.id"></div>
                        </div>
                        <div class="space-y-4 text-left">
                            <div><label>Alamat Sekolah Asal (Jalan/KP/RT/RW)</label><input type="text" name="alamat_sekolah_asal" placeholder="Jl. Raya Merdeka No. 123" required></div>
                            <div class="grid-paired">
                                <div><label>Wilayah</label><select name="status_wil_sekolah_asal" required><option value="" selected disabled>-- Pilih --</option><option value="Desa">Desa</option><option value="Kelurahan">Kelurahan</option></select></div>
                                <div><input type="text" name="desa_sekolah_asal" required placeholder="Nama Desa/Kel"></div>
                            </div>
                            <div><label>Kecamatan Asal</label><input type="text" name="kec_sekolah_asal" placeholder="Nama Kecamatan" required></div>
                            <div class="grid-paired">
                                <div><label>Daerah</label><select name="status_kab_sekolah_asal" required><option value="" selected disabled>-- Pilih --</option><option value="Kabupaten">Kabupaten</option><option value="Kota">Kota</option></select></div>
                                <div><input type="text" name="kab_sekolah_asal" placeholder="Nama Kab/Kota" required></div>
                            </div>
                            <div><label>Provinsi</label><input type="text" name="prov_sekolah_asal" placeholder="Contoh: Banten" required></div>
                        </div>
                        <div><label>Website (Opsional)</label><input type="text" name="website_sekolah" placeholder="sdn-contoh.sch.id"></div>
                    </div>

                    <div class="space-y-5 pt-4">
                        <div class="text-blue-600 font-black text-[10px] uppercase border-b pb-1 tracking-widest text-left">B. Biodata Siswa</div>
                        <div class="grid grid-cols-1 gap-5 text-left">
                            <div><label>Nama Lengkap Siswa</label><input type="text" name="nama_siswa" required placeholder="NAMA LENGKAP SISWA" class="font-bold"></div>
                            <div class="grid grid-cols-2 gap-5 text-left">
                                <div><label>Nomor Induk</label><input type="text" name="nis" placeholder="NIS" required></div>
                                <div><label>NISN (Nasional)</label><input type="text" name="nisn" placeholder="NISN" required class="font-mono"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-5 text-left">
                                <div><label>Jenis Kelamin</label><select name="jenis_kelamin" required><option value="">-- Pilih --</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                                <div><label>Siswa Kelas</label><select name="kelas_siswa" required><option value="">-- Pilih --</option><option value="I (satu)">I (satu)</option><option value="II (dua)">II (dua)</option><option value="III (tiga)">III (tiga)</option><option value="IV (empat)">IV (empat)</option><option value="V (lima)">V (lima)</option><option value="VI (enam)">VI (enam)</option></select></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-10">
                    <div class="space-y-5">
                        <div class="text-blue-600 font-black text-[10px] uppercase border-b pb-1 tracking-widest text-left font-black">C. Orang Tua/ Wali</div>
                        <div class="grid grid-cols-1 gap-5 text-left">
                            <div><label>Nama Orang Tua/ Wali</label><input type="text" name="nama_ortu" required placeholder="Nama Orang Tua" class="font-bold"></div>
                            <div><label>Pekerjaan</label><input type="text" name="pekerjaan_ortu" placeholder="Contoh: Wiraswasta" required></div>
                            <div><label>Alamat Orang Tua (Jalan/KP/RT/RW)</label><input type="text" name="alamat_asal_ortu" placeholder="Alamat lengkap saat ini" required></div>
                            <div class="space-y-4">
                                <div class="grid-paired">
                                    <div><label>Wilayah</label><select name="status_wil_asal_ortu" required><option value="" selected disabled>-- Pilih --</option><option value="Desa">Desa</option><option value="Kelurahan">Kelurahan</option></select></div>
                                    <div><input type="text" name="desa_asal_ortu" required placeholder="Nama Desa/Kel"></div>
                                </div>
                                <div><label>Kecamatan</label><input type="text" name="kec_asal_ortu" placeholder="Kecamatan" required></div>
                                <div class="grid-paired">
                                    <div><label>Daerah</label><select name="status_kab_asal_ortu" required><option value="" selected disabled>-- Pilih --</option><option value="Kabupaten">Kabupaten</option><option value="Kota">Kota</option></select></div>
                                    <div><input type="text" name="kab_asal_ortu" placeholder="Kab/Kota"></div>
                                </div>
                                <div><label>Provinsi</label><input type="text" name="prov_asal_ortu" placeholder="Provinsi"></div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-5 pt-4">
                        <div class="text-blue-600 font-black text-[10px] uppercase border-b pb-1 tracking-widest text-left font-black">D. Sekolah Tujuan Mutasi</div>
                        <div class="grid grid-cols-1 gap-5 text-left">
                            <div><label>Nama Sekolah Tujuan</label><input type="text" name="sekolah_tujuan" required placeholder="Nama Sekolah Tujuan" class="font-bold text-blue-600"></div>
                            <div class="space-y-4">
                                <div class="grid-paired text-left">
                                    <div><label>Wilayah</label><select name="status_wil_tujuan" required><option value="" selected disabled>-- Pilih --</option><option value="Desa">Desa</option><option value="Kelurahan">Kelurahan</option></select></div>
                                    <div><input type="text" name="desa_tujuan" required placeholder="Nama Desa/Kel"></div>
                                </div>
                                <div><label>Kecamatan Tujuan</label><input type="text" name="kec_tujuan" placeholder="Kecamatan Tujuan" required></div>
                                <div class="grid-paired">
                                    <div><label>Daerah</label><select name="status_kab_tujuan" required><option value="" selected disabled>-- Pilih --</option><option value="Kabupaten">Kabupaten</option><option value="Kota">Kota</option></select></div>
                                    <div><input type="text" name="kab_tujuan" placeholder="Kab/Kota Tujuan"></div>
                                </div>
                                <div><label>Provinsi Tujuan</label><input type="text" name="prov_tujuan" placeholder="Provinsi Tujuan" required></div>
                                <div><label>Alasan Pindah</label><input type="text" name="alasan_pindah" placeholder="Contoh: Mengikuti Orang Tua" required class="font-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-admin-box p-8 md:p-12 rounded-2xl space-y-8 text-left mt-8 border-2 border-blue-100/50">
                <div class="text-blue-600 font-black text-[11px] uppercase tracking-widest border-b border-blue-200 pb-3 text-left font-black">E. Administrasi Tanda Tangan</div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-10 text-left">
                    <div class="lg:col-span-2"><label class="text-blue-400 font-black">Nomor Surat S-13 (Agenda)</label><input type="text" name="nomor_surat" placeholder="Contoh: 421.2/001/2060XXXX/I/2026" class="bg-white border-blue-100 font-mono text-left w-full shadow-sm"></div>
                    <div><label class="text-blue-400 font-black text-left">Tanggal Surat</label><input type="date" name="tanggal_surat" class="bg-white border-blue-100 text-left w-full shadow-sm"></div>
                    <div><label class="text-blue-400 font-black text-left">Lokasi TTD</label><input type="text" name="lokasi_ttd" placeholder="Contoh: Perdana" class="bg-white border-blue-100 font-bold text-left w-full shadow-sm"></div>
                    <div class="lg:col-span-2"><label class="text-blue-400 font-black text-left">Nama Kepala Sekolah</label><input type="text" name="kepsek_nama" value="Dr. Edi Brata, M.Pd." class="bg-white border-blue-100 font-bold text-left w-full shadow-sm"></div>
                    <div class="lg:col-span-2"><label class="text-blue-400 font-black text-left">NIP Kepala Sekolah</label><input type="text" name="kepsek_nip" placeholder="NIP Kepala Sekolah" class="bg-white border-blue-100 font-mono text-slate-500 text-left w-full shadow-sm"></div>
                </div>
            </div>
        `;

        window.handleProcessData = async (e, mode = 'add', docId = null) => {
            e.preventDefault();
            if (!auth.currentUser) return showToast("Koneksi bermasalah...");
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                if (mode === 'add') {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), data);
                    showToast("Data Berhasil Disimpan");
                    e.target.reset();
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, docId), data);
                    showToast("Data Berhasil Diupdate");
                    window.toggleModal('modal-edit-pindah');
                }
                window.switchTab('dashboard');
            } catch (err) { console.error(err); showToast("Gagal memproses"); }
        };

        window.openEditModal = (id) => {
            const item = window.state.database.find(p => p.id === id);
            if(!item) return;
            const container = document.getElementById('edit-form-container');
            container.innerHTML = window.getFormHTML();
            const form = document.getElementById('form-edit-pindah');
            form.dataset.docId = id;
            Object.keys(item).forEach(key => {
                const el = form.elements[key];
                if(el && el.type !== 'file') el.value = item[key];
            });
            window.toggleModal('modal-edit-pindah');
        };

        // DUPLICATE FUNCTIONALITY
        window.duplicateItem = (id) => {
            const item = window.state.database.find(p => p.id === id);
            if(!item) return;
            window.switchTab('formulir');
            const form = document.getElementById('form-main');
            if(!form) return;
            // Populate form fields with duplicate data
            Object.keys(item).forEach(key => {
                const el = form.elements[key];
                if(el && el.type !== 'file' && key !== 'id') {
                    el.value = item[key];
                }
            });
            showToast("Arsip diduplikasi ke formulir input.");
        };

        function formatTanggalIndo(dateStr) {
            if (!dateStr) return "-";
            const bulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const parts = dateStr.split('-');
            return parts.length === 3 ? `${parts[2]} ${bulan[parseInt(parts[1]) - 1]} ${parts[0]}` : dateStr;
        }

        function toFormalName(str) {
            if(!str) return "";
            return str.toLowerCase().split(' ').map(w => (w === 'sd' || w === 'sdn') ? w.toUpperCase() : w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        window.getSortedDatabase = () => {
            return [...window.state.database].sort((a, b) => {
                const partA = (a.nomor_surat || "").split('/');
                const partB = (b.nomor_surat || "").split('/');
                const yrA = parseInt(partA[4]) || 0;
                const yrB = parseInt(partB[4]) || 0;
                if (yrB !== yrA) return yrB - yrA;
                const numA = parseInt(partA[1]) || 0;
                const numB = parseInt(partB[1]) || 0;
                return numB - numA;
            });
        };

        window.getFilteredProductionList = () => {
            const sorted = window.getSortedDatabase();
            if (!window.state.recipientSearchQuery) return sorted;
            return sorted.filter(p => p.nama_siswa.toLowerCase().includes(window.state.recipientSearchQuery.toLowerCase()));
        };

        window.generateTemplates = (p) => {
            const tgl = formatTanggalIndo(p.tanggal_surat);
            const style = `font-family: 'Times New Roman', serif; background: white; width: 215mm; height: 330mm; padding: 10mm 20mm; box-sizing: border-box; color: black; line-height: 1.3; font-size: 12pt; text-align: left; position: relative; overflow: hidden; font-style: normal !important;`;
            const logo = window.state.globalLogo || "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Lambang_Kabupaten_Pandeglang.png/120px-Lambang_Kabupaten_Pandeglang.png";
            
            const kabLabel = p.status_kab_sekolah_asal || 'Kabupaten';
            const wilLabel = p.status_wil_sekolah_asal || 'Desa';
            const kabKop = kabLabel === 'Kabupaten' ? 'Kab.' : kabLabel;
            const alamatKop = `Alamat: ${p.alamat_sekolah_asal || ''} ${wilLabel} ${p.desa_sekolah_asal || ''} Kec. ${p.kec_sekolah_asal || ''} ${kabKop} ${p.kab_sekolah_asal || ''} Provinsi ${p.prov_sekolah_asal || ''}`;

            // Overlay Signature Logic: Space reduced to 3 lines (approx 65px)
            // Enhanced with rotation
            let signatureOverlay = '';
            if (window.state.signatureMode === 'digital' && window.state.globalSignature) {
                signatureOverlay = `
                    <img src="${window.state.globalSignature}" style="max-height: 110px; width: auto; position: absolute; left: 50%; top: 50%; transform: translate(calc(-50% + ${window.state.sigOffsetX}px), calc(-50% + ${window.state.sigOffsetY}px)) scale(${window.state.sigScale}) rotate(${window.state.sigRotate}deg); z-index: 50;">
                `;
            }

            const s13 = `
                <div class="print-page" style="${style}">
                    <div style="border-bottom: 4px double black; margin-bottom: 8px; padding-bottom: 4px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="width: 100px; vertical-align: middle; padding-right: -100px;">
                                    <img src="${logo}" style="width: 100px; height: auto; display: block;">
                                </td>
                                <td style="text-align: center; vertical-align: middle; padding-right: -100px;">
                                    <div style="font-size: 16pt; font-weight: bold; text-transform: uppercase; line-height: 1.1;">PEMERINTAH ${kabLabel.toUpperCase()} ${(p.kab_sekolah_asal || 'DAERAH').toUpperCase()}</div>
                                    <div style="font-size: 14pt; font-weight: bold; text-transform: uppercase; white-space: nowrap; line-height: 1.1;">DINAS PENDIDIKAN, KEPEMUDAAN DAN OLAHRAGA</div>
                                    <div style="font-size: 22pt; font-weight: bold; text-transform: uppercase; line-height: 1.1;">${p.nama_sekolah_asal || 'NAMA SEKOLAH'}</div>
                                    <div style="font-size: 11pt; font-weight: bold; text-transform: uppercase; line-height: 1.1;">KECAMATAN ${(p.kec_sekolah_asal || '').toUpperCase()}</div>
                                    <div style="font-size: 8.5pt; margin-top: 4px;">${alamatKop}</div>
                                    <div style="font-size: 8.5pt;">NPSN: ${p.npsn_sekolah_asal || ''}; Email: ${p.email_sekolah_asal || ''}</div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: center; margin-bottom: 12px;">
                        <h4 style="margin:0; font-weight: bold; text-transform: uppercase; font-size: 12pt;">SURAT KETERANGAN PINDAH SEKOLAH</h4>
                        <p style="margin:0;">Nomor: ${p.nomor_surat || '......../......../........'}</p>
                    </div>
                    <div style="text-align: justify; width: 100%;">
                        <p style="margin-bottom: 10px;">Yang bertanda tangan di bawah ini, Kepala ${toFormalName(p.nama_sekolah_asal)} Kecamatan ${p.kec_sekolah_asal} ${kabLabel} ${p.kab_sekolah_asal} Provinsi ${p.prov_sekolah_asal}, menerangkan bahwa:</p>
                        <table style="width: 100%; margin-left: 25px; margin-bottom: 10px; border-collapse: collapse;">
                            <tr style="vertical-align: top;"><td width="180">Nama</td><td width="15">:</td><td style="font-weight:bold; text-transform:capitalize;">${p.nama_siswa}</td></tr>
                            <tr style="vertical-align: top;"><td>Nomor Induk/ NISN</td><td>:</td><td>${p.nis}/ ${p.nisn}</td></tr>
                            <tr style="vertical-align: top;"><td>Jenis Kelamin</td><td>:</td><td>${p.jenis_kelamin}</td></tr>
                            <tr style="vertical-align: top;"><td>Siswa Kelas</td><td>:</td><td>${p.kelas_siswa}</td></tr>
                        </table>
                        <p style="margin-bottom: 10px;">Sesuai permohonan pindah sekolah oleh orang tua/ wali murid:</p>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                            <tr style="vertical-align: top;"><td width="25"></td><td width="180">Nama</td><td width="15">:</td><td style="font-weight: bold;">${p.nama_ortu}</td></tr>
                            <tr style="vertical-align: top;"><td></td><td>Pekerjaan</td><td>:</td><td>${p.pekerjaan_ortu}</td></tr>
                            <tr style="vertical-align: top;"><td></td><td>Alamat</td><td>:</td><td>${p.alamat_asal_ortu}, ${p.status_wil_asal_ortu} ${p.desa_asal_ortu}, <br> Kec. ${p.kec_asal_ortu}, ${p.status_kab_asal_ortu} ${p.kab_asal_ortu}, Provinsi ${p.prov_asal_ortu}</td></tr>
                        </table>
                        <p style="margin-bottom: 10px;">Telah mengajukan pindah ke <b>${toFormalName(p.sekolah_tujuan)}</b> di ${p.status_wil_tujuan} ${p.desa_tujuan}, Kecamatan ${p.kec_tujuan}, ${p.status_kab_tujuan} ${p.kab_tujuan}, Provinsi ${p.prov_tujuan} dengan alasan <b style="text-transform: lowercase;">${p.alasan_pindah}</b>
.</p>
                        <p style="margin-bottom: 15px;">Bersama ini kami sertakan buku laporan hasil belajar dan surat permohonan pindah dari orang tua/ wali yang bersangkutan.</p>
                    </div>
                    
                    <table style="width: 100%; margin-bottom: 15px; border-collapse: collapse;">
                        <tr><td width="60%"></td><td>${p.lokasi_ttd}, ${tgl}<br>Kepala Sekolah,</td></tr>
                        <tr><td></td><td style="height: 65px; position: relative; vertical-align: middle;">
                            ${signatureOverlay}
                        </td></tr>
                        <tr><td></td><td><b>${p.kepsek_nama}</b><br>NIP. ${p.kepsek_nip}</td></tr>
                    </table>

                    <div style="margin-top: 27px; border-top: 1px dashed #444; padding-top: 10px;">
                        <p style="margin-bottom: 10px; font-style: regular;">Setelah siswa tersebut di atas diterima, harap isian di bawah ini dikirim ke alamat di atas.</p>
                        <table style="width: 100%; line-height: 1.5; border-collapse: collapse;">
                            <tr><td width="150">NPSN/ NSS</td><td width="15">:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                            <tr><td>Nama sekolah</td><td>:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                            <tr><td>Status sekolah</td><td>:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                            <tr><td>Alamat sekolah</td><td>:</td><td style="border-bottom: 1px dotted black;"></td></tr>
                            <tr><td colspan="3"><table style="width:100%; border-collapse:collapse; margin-top:5px;"><tr><td width="150">Desa/ Kelurahan</td><td width="15">:</td><td style="border-bottom:1px dotted black; width:170px;">&nbsp;</td><td style="padding-left:15px; width:45px;">Kec.</td><td width="15">:</td><td style="border-bottom:1px dotted black;">&nbsp;</td></tr><tr><td>Kabupaten/ Kota</td><td>:</td><td style="border-bottom:1px dotted black;">&nbsp;</td><td style="padding-left:15px;">Provinsi</td><td>:</td><td style="border-bottom:1px dotted black;">&nbsp;</td></tr><tr><td>Diterima tanggal</td><td>:</td><td style="border-bottom:1px dotted black;">&nbsp;</td><td style="padding-left:15px;">Di kelas</td><td>:</td><td style="border-bottom:1px dotted black;">&nbsp;</td></tr></table></td></tr>
                        </table>
                        <table style="width: 100%; margin-top: 20px;">
                            <tr><td width="60%"></td><td>.......................................... 20....<br>Kepala Sekolah,<br><br><br><br>..................................................<br>NIP.</td></tr>
                        </table>
                    </div>
                </div>`;

            const s12 = `
                <div class="print-page" style="${style} page-break-before: always; border-top: 1px dashed #ccc; padding-top: 60px;">
                    <div style="text-align: right; font-weight: bold; font-size: 10pt; margin-bottom: 15px;">FORMAT: S-12</div>
                    <h3 style="text-align: center; font-weight: bold; margin-bottom: 30px; text-transform: uppercase; font-size: 14pt;">SURAT PERMOHONAN PINDAH SEKOLAH</h3>
                    
                    <div style="margin-bottom: 25px; line-height: 1.1;">
                        <p style="margin:0; padding:0;">Yth. Kepala ${toFormalName(p.nama_sekolah_asal)}</p>
                        <p style="margin:0; padding:0;">di -</p>
                        <p style="margin:0; padding:0; font-weight:regular;">${p.lokasi_ttd} - ${p.kec_sekolah_asal}</p>
                    </div>

                    <p style="margin-bottom: 10px;">Dengan hormat,</p>
                    <p style="margin-bottom: 10px;">Yang bertanda tangan di bawah ini:</p>
                    <table style="width: 100%; margin-bottom: 15px; border-collapse: collapse;">
                        <tr style="vertical-align: top;"><td width="160">Nama</td><td width="15">:</td><td style="font-weight: bold;">${p.nama_ortu}</td></tr>
                        <tr style="vertical-align: top;"><td>Pekerjaan</td><td>:</td><td>${p.pekerjaan_ortu}</td></tr>
                        <tr style="vertical-align: top;"><td>Alamat</td><td>:</td><td>${p.alamat_asal_ortu}, ${p.status_wil_asal_ortu} ${p.desa_asal_ortu}, <br> Kec. ${p.kec_asal_ortu}, ${p.status_kab_asal_ortu} ${p.kab_asal_ortu}, Provinsi ${p.prov_asal_ortu}</td></tr>
                    </table>
                    <p style="margin-bottom: 10px;">Orang tua/ Wali *) murid dari:</p>
                    <table style="width: 100%; margin-bottom: 15px; border-collapse: collapse;">
                        <tr style="vertical-align: top;"><td width="160">Nama</td><td width="15">:</td><td style="font-weight:bold;">${p.nama_siswa}</td></tr>
                        <tr style="vertical-align: top;"><td>Nomor Induk/ NISN</td><td>:</td><td>${p.nis}/ ${p.nisn}</td></tr>
                        <tr style="vertical-align: top;"><td>Jenis Kelamin</td><td>:</td><td>${p.jenis_kelamin}</td></tr>
                        <tr style="vertical-align: top;"><td>Murid Kelas</td><td>:</td><td>${p.kelas_siswa}</td></tr>
                    </table>
                    <p style="margin-bottom: 10px;">Melalui ini mengajukan pindah belajar untuk murid tersebut di atas ke:</p>
                    <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                        <tr style="vertical-align: top;"><td width="160">Sekolah</td><td width="15">:</td><td style="font-weight:bold;">${toFormalName(p.sekolah_tujuan)}</td></tr>
                        <tr style="vertical-align: top;"><td>Desa/ Kelurahan</td><td>:</td><td>${p.desa_tujuan}</td></tr>
                        <tr style="vertical-align: top;"><td>Kecamatan</td><td>:</td><td>${p.kec_tujuan}</td></tr>
                        <tr style="vertical-align: top;"><td>Kabupaten/ Kota</td><td>:</td><td>${p.kab_tujuan}</td></tr>
                        <tr style="vertical-align: top;"><td>Provinsi</td><td>:</td><td>${p.prov_tujuan}</td></tr>
                        <tr style="vertical-align: top;"><td>Dengan alasan</td><td>:</td><td style="font-weight:bold;">${p.alasan_pindah}</td></tr>
                    </table>
                    <p style="margin-bottom: 30px;">Atas perhatian dan kerjasama Saudara, kami ucapkan terima kasih.</p>
                    <table style="width: 100%;"><tr><td width="65%"></td><td>${p.lokasi_ttd}, ${tgl}<br>Orang Tua/ Wali *) Murid,<br><br><br><br><b>${p.nama_ortu}</b></td></tr></table>
                    <p style="font-size: 9pt; margin-top: 25px;">*) Coret yang bukan</p>
                </div>`;
            return s13 + s12;
        };

        window.updateDashboard = () => {
            document.getElementById('stat-total').textContent = window.state.database.length;
            const latest = [...window.state.database].reverse().slice(0, 6);
            document.getElementById('dashboard-grid').innerHTML = latest.length ? latest.map(item => `
                <div class="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm hover:shadow-lg hover:scale-[1.03] transition-all duration-300 cursor-default group">
                    <div class="text-left font-bold text-xs text-slate-800 uppercase group-hover:text-blue-600 transition-colors">${item.nama_siswa}</div>
                    <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg uppercase truncate max-w-[120px] shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-all">${item.sekolah_tujuan}</span>
                </div>
            `).join('') : '<p class="col-span-full text-slate-300 text-[10px] font-bold py-10 text-center uppercase">Belum ada data masuk</p>';
        };

        window.renderDatabase = () => {
            const sorted = window.getSortedDatabase();
            let filtered = sorted;
            if(window.state.searchQuery) filtered = filtered.filter(p => p.nama_siswa.toLowerCase().includes(window.state.searchQuery));
            
            document.getElementById('db-grid').innerHTML = filtered.map(item => `
                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm relative group text-left card-hover">
                    <div class="absolute top-4 right-4 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-300 z-10">
                        <button onclick="duplicateItem('${item.id}')" class="p-1.5 bg-green-50 text-green-600 rounded-lg shadow-sm hover:bg-green-600 hover:text-white transition-all" title="Duplikat"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg></button>
                        <button onclick="openEditModal('${item.id}')" class="p-1.5 bg-blue-50 text-blue-600 rounded-lg shadow-sm hover:bg-blue-600 hover:text-white transition-all" title="Edit"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button onclick="deleteItem('${item.id}')" class="p-1.5 bg-red-50 text-red-600 rounded-lg shadow-sm hover:bg-red-600 hover:text-white transition-all" title="Hapus"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                    
                    <h4 class="font-extrabold text-sm uppercase text-slate-900 border-b pb-2 mb-3 pr-12 group-hover:text-blue-600 transition-colors truncate" title="${item.nama_siswa}">${item.nama_siswa}</h4>
                    
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-black uppercase text-slate-400 w-16 shrink-0">No. Surat</span>
                            <p class="text-[9px] text-slate-600 font-mono bg-slate-50 px-1.5 py-0.5 rounded truncate flex-grow">${item.nomor_surat || '-'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-black uppercase text-slate-400 w-16 shrink-0">Dari</span>
                            <p class="text-[9px] text-slate-700 font-bold truncate flex-grow">${item.nama_sekolah_asal || '-'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-black uppercase text-slate-400 w-16 shrink-0">Ke</span>
                            <p class="text-[9px] text-blue-600 font-bold truncate flex-grow">${item.sekolah_tujuan || '-'}</p>
                        </div>
                        <div class="flex items-center gap-2 border-t pt-2 mt-2">
                            <span class="text-[8px] font-black uppercase text-slate-400 w-16 shrink-0">Tgl Pindah</span>
                            <p class="text-[9px] text-slate-900 font-extrabold italic-none">${formatTanggalIndo(item.tanggal_surat)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        window.renderRecipientView = () => {
            const list = window.getFilteredProductionList();
            const preview = document.getElementById('merge-result-preview');
            
            if (!list.length) {
                preview.innerHTML = `<p class="py-20 text-center font-bold text-slate-400">DATA TIDAK DITEMUKAN / KOSONG</p>`;
                document.getElementById('recipient-name').textContent = "Pilih Data";
                document.getElementById('current-info').textContent = "0/0";
                return;
            }

            if (window.state.currentIndex >= list.length) window.state.currentIndex = 0;
            
            const p = list[window.state.currentIndex];
            window.state.processedHtml = window.generateTemplates(p);
            preview.innerHTML = window.state.processedHtml;
            document.getElementById('recipient-name').textContent = p.nama_siswa;
            document.getElementById('current-info').textContent = `${window.state.currentIndex + 1}/${list.length}`;
            updateSignatureUI();
        };

        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user) {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', collectionName), (snap) => {
                    window.state.database = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(window.state.activeTab === 'dashboard') window.updateDashboard();
                    if(window.state.activeTab === 'database') window.renderDatabase();
                    if(window.state.activeTab === 'produksi') window.renderRecipientView();
                });

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        window.state.globalLogo = data.logo || '';
                        window.state.globalSignature = data.signature || '';
                        window.state.sigOffsetX = data.sigOffsetX || 0;
                        window.state.sigOffsetY = data.sigOffsetY || 0;
                        window.state.sigScale = data.sigScale || 1;
                        window.state.sigRotate = data.sigRotate || 0;
                        if(window.state.activeTab === 'produksi') window.renderRecipientView();
                    }
                });
            }
        });

        window.addEventListener('load', () => {
            document.getElementById('form-container-main').innerHTML = window.getFormHTML();
            signInAnonymously(auth);
            updateNavigationUI();
        });

        window.handleLogoUpload = (e) => {
            const f = e.target.files[0];
            if (!f || !auth.currentUser) return;
            const r = new FileReader();
            r.onload = async (ev) => { 
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { logo: ev.target.result }, { merge: true });
                    showToast("Logo Berhasil Disimpan di Cloud"); 
                } catch (err) { showToast("Gagal Sinkronisasi Logo"); }
            };
            r.readAsDataURL(f);
        };

        window.handleSignatureUpload = (e) => {
            const f = e.target.files[0];
            if (!f || !auth.currentUser) return;
            const r = new FileReader();
            r.onload = async (ev) => { 
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { signature: ev.target.result }, { merge: true });
                    showToast("Tanda Tangan Berhasil Disimpan"); 
                } catch (err) { showToast("Gagal Sinkronisasi TTD"); }
            };
            r.readAsDataURL(f);
        };

        window.updateSigOffset = async (axis, val) => {
            window.state[axis === 'x' ? 'sigOffsetX' : 'sigOffsetY'] = parseInt(val);
            if(window.state.activeTab === 'produksi') window.renderRecipientView();
            try {
                const payload = axis === 'x' ? { sigOffsetX: parseInt(val) } : { sigOffsetY: parseInt(val) };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), payload, { merge: true });
            } catch (err) {}
        };

        window.updateSigScale = async (val) => {
            const scale = parseFloat(val);
            window.state.sigScale = scale;
            if(window.state.activeTab === 'produksi') window.renderRecipientView();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { sigScale: scale }, { merge: true });
            } catch (err) {}
        };

        window.updateSigRotate = async (val) => {
            const deg = parseInt(val);
            window.state.sigRotate = deg;
            if(window.state.activeTab === 'produksi') window.renderRecipientView();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { sigRotate: deg }, { merge: true });
            } catch (err) {}
        };

        window.deleteSignature = async () => {
            if (!confirm("Hapus tanda tangan dari cloud?")) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { signature: deleteField() }, { merge: true });
                showToast("Tanda Tangan Terhapus");
            } catch (err) { showToast("Gagal Menghapus"); }
        };

        window.setSignatureMode = (mode) => {
            window.state.signatureMode = mode;
            localStorage.setItem('sipindah_sig_mode', mode);
            updateSignatureUI();
            window.renderRecipientView();
        };

        window.toggleSettings = () => {
            window.state.settingsExpanded = !window.state.settingsExpanded;
            const content = document.getElementById('settings-content');
            const arrow = document.getElementById('settings-arrow');
            if (window.state.settingsExpanded) {
                content.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        };

        function updateSignatureUI() {
            const mBtn = document.getElementById('btn-sig-manual');
            const dBtn = document.getElementById('btn-sig-digital');
            const nudgeBlock = document.getElementById('sig-nudge-block');
            
            if(!mBtn || !dBtn) return;

            if(window.state.signatureMode === 'manual') {
                mBtn.className = "flex-1 py-2 text-[8px] font-black uppercase rounded-md bg-blue-600 text-white shadow-md transition-all";
                dBtn.className = "flex-1 py-2 text-[8px] font-black uppercase rounded-md text-slate-400 bg-slate-50 transition-all hover:bg-slate-200";
                if(nudgeBlock) nudgeBlock.classList.add('hidden');
            } else {
                dBtn.className = "flex-1 py-2 text-[8px] font-black uppercase rounded-md bg-blue-600 text-white shadow-md transition-all";
                mBtn.className = "flex-1 py-2 text-[8px] font-black uppercase rounded-md text-slate-400 bg-slate-50 transition-all hover:bg-slate-200";
                if(nudgeBlock) nudgeBlock.classList.remove('hidden');
            }
        }

        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(window.state.database);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Arsip");
            XLSX.writeFile(wb, "Arsip_Mutasi_Master.xlsx");
        };

        window.printDoc = () => {
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Cetak</title></head><body style="margin:0; background:#eee;">${window.state.processedHtml}</body></html>`);
            w.document.close(); w.focus();
            setTimeout(() => { w.print(); w.close(); }, 700);
        };

        window.prevRecipient = () => { 
            if (window.state.currentIndex > 0) { 
                window.state.currentIndex--; window.renderRecipientView(); 
            } 
        };
        window.nextRecipient = () => { 
            const listLength = window.getFilteredProductionList().length;
            if (window.state.currentIndex < listLength - 1) { 
                window.state.currentIndex++; window.renderRecipientView(); 
            } 
        };

        window.toggleModal = (id) => { const m = document.getElementById(id); m.classList.toggle('hidden'); m.classList.toggle('flex'); };

        window.loginAdmin = (e) => {
            e.preventDefault();
            if (document.getElementById('admin-password').value === 'EdiBrata#1') {
                window.state.isAdmin = true;
                if(document.getElementById('admin-remember').checked) localStorage.setItem('edibrata_v15_admin', 'true');
                showToast("Akses Terbuka");
                window.switchTab('dashboard');
            } else showToast("Sandi Salah!");
        };

        window.logoutAdmin = () => { window.state.isAdmin = false; localStorage.removeItem('edibrata_v15_admin'); showToast("Logout Berhasil"); window.switchTab('dashboard'); };

        function updateNavigationUI() {
            ['nav-database', 'nav-produksi', 'nav-formulir'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', !window.state.isAdmin));
        }

        window.deleteItem = async (id) => {
            if (confirm("Hapus arsip ini permanen?")) { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id)); showToast("Terhapus"); } catch (e) { showToast("Gagal"); } }
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen text-left">
    <div id="toast" class="fixed bottom-8 right-8 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl hidden z-[200] font-bold text-xs uppercase border border-white/10"></div>

    <header class="bg-white border-b sticky top-0 z-40 no-print">
        <div class="max-w-[1600px] mx-auto px-6 flex items-center justify-between h-20">
            <div class="flex items-center gap-4 text-left">
                <div class="w-14 h-14 bg-slate-300 rounded-xl flex items-center justify-center text-white shadow-xl transform transition-transform duration-300 ease-in-out hover:scale-110 cursor-pointer">
                    <img src="https://raw.githubusercontent.com/edibrata/image/main/FotoEdiBrata.jpg" alt="Edi Brata" class="w-13 h-13 rounded-xl object-cover">
                </div>
                <div class="text-left text-slate-900">
                    <h1 class="font-extrabold text-lg leading-none uppercase">SIMUDIK</h1>
                    <p class="text-[12px] text-slate-900 font-bold tracking-widest leading-tight">
                     Sistem Informasi Mutasi Peserta Didik<br>
                     <span class="text-blue-800 font-bold">By Edi Brata</span>
                    </p>
               </div>
            </div>
            <nav class="flex gap-1.5 bg-slate-100 p-1.5 rounded-xl">
                <button onclick="switchTab('dashboard')" data-tab="dashboard" class="tab-btn active px-4 py-2 text-[10px] uppercase rounded-lg border-blue-600 text-blue-600 bg-blue-50">Home</button>
                <button id="nav-formulir" onclick="switchTab('formulir')" data-tab="formulir" class="tab-btn px-4 py-2 text-[10px] uppercase rounded-lg text-slate-500 hidden hover:bg-white hover:text-blue-600">Buat Surat</button>
                <button id="nav-database" onclick="switchTab('database')" data-tab="database" class="tab-btn px-4 py-2 text-[10px] uppercase rounded-lg text-slate-500 hidden hover:bg-white hover:text-blue-600">Arsip</button>
                <button id="nav-produksi" onclick="switchTab('produksi')" data-tab="produksi" class="tab-btn px-4 py-2 text-[10px] uppercase rounded-lg text-slate-500 hidden hover:bg-white hover:text-blue-600">Cetak</button>
                <button onclick="switchTab('admin')" data-tab="admin" class="tab-btn px-4 py-2 text-[10px] uppercase rounded-lg text-slate-500 hover:bg-white hover:text-blue-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-4 md:p-10 flex-grow w-full text-left">
        <section id="dashboard" class="tab-content space-y-8 animate-in fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-stretch text-left">
                <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-10 text-white relative shadow-2xl overflow-hidden text-left hover:shadow-blue-200/50 transition-all duration-500 group">
                    <div class="relative z-10 text-left">
                        <h2 class="text-4xl font-black mb-3 uppercase leading-tight text-left group-hover:scale-[1.01] transition-transform">Master Mutasi Digital</h2>
                        <p class="text-blue-100 text-sm max-w-md opacity-90 leading-relaxed text-left font-bold italic-none">Kelola berkas S-13 dan S-12 secara otomatis dan akurat.</p>
                        <button onclick="switchTab('formulir')" class="mt-8 bg-white text-blue-600 px-10 py-4 rounded-xl font-black text-[11px] uppercase tracking-widest shadow-xl hover:scale-110 active:scale-95 transition-all text-center">Entri Data Baru</button>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center items-center text-center hover:border-blue-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <p class="text-slate-400 font-black text-[10px] uppercase tracking-widest text-center">Arsip Terdaftar</p>
                    <h3 id="stat-total" class="text-7xl font-black text-slate-900 mt-4 tracking-tighter leading-none text-center">0</h3>
                </div>
            </div>
            <div class="space-y-6 text-left">
                <h4 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em] px-2 flex items-center gap-2 text-left"><span class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></span> Entri Terbaru</h4>
                <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left"></div>
            </div>
        </section>

        <section id="formulir" class="tab-content hidden animate-in slide-in-from-bottom-6 text-left">
            <div class="bg-white p-6 md:p-12 rounded-2xl shadow-xl border border-slate-100 text-left hover:shadow-2xl transition-shadow duration-700">
                <form onsubmit="window.handleProcessData(event, 'add')" id="form-main">
                    <div id="form-container-main"></div>
                    <button type="submit" class="w-full mt-10 bg-blue-600 text-white font-black py-6 rounded-xl shadow-xl hover:bg-blue-700 hover:scale-[1.02] active:scale-95 transition-all text-sm uppercase tracking-widest text-center">Simpan Berkas Mutasi Master</button>
                </form>
            </div>
        </section>

        <section id="database" class="tab-content hidden space-y-8 animate-in fade-in text-left">
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col md:flex-row gap-6 items-center justify-between text-left hover:shadow-md transition-shadow">
                <input type="text" oninput="window.state.searchQuery = this.value.toLowerCase(); window.renderDatabase();" placeholder="CARI NAMA SISWA..." class="w-full md:max-w-md px-10 py-4 bg-slate-50 border-none rounded-xl text-[11px] font-black uppercase outline-none shadow-inner text-left focus:bg-white">
                <button onclick="window.exportExcel()" class="px-8 py-4 bg-blue-600 text-white rounded-xl font-black text-[10px] uppercase shadow-lg hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all text-center">Ekspor XLSX</button>
            </div>
            <div id="db-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-left"></div>
        </section>

        <section id="produksi" class="tab-content hidden h-full text-left">
            <div class="flex flex-col lg:flex-row gap-8 h-[calc(100vh-160px)] text-left">
                <aside class="lg:w-80 bg-white p-6 rounded-2xl border border-slate-100 shadow-xl flex flex-col gap-6 no-print shrink-0 text-left overflow-y-auto scrollbar-hide hover:shadow-2xl transition-shadow">
                    
                    <div class="text-left border-b border-slate-50 pb-4">
                        <label class="font-black text-slate-400 text-[10px] uppercase tracking-widest">Cari & Navigasi</label>
                        <input type="text" oninput="window.state.recipientSearchQuery = this.value; window.state.currentIndex = 0; window.renderRecipientView();" placeholder="NAMA SISWA..." class="w-full mt-2 px-4 py-3 bg-slate-50 border-none rounded-xl text-[10px] font-black uppercase outline-none shadow-inner text-left mb-4 focus:bg-white transition-colors">
                        
                        <div class="flex items-center justify-between bg-slate-50 p-2 rounded-xl shadow-inner group">
                            <button onclick="prevRecipient()" class="p-2 bg-white rounded-lg shadow-sm text-slate-400 hover:text-blue-600 hover:bg-blue-50 font-bold active:scale-90 transition-all text-left"></button>
                            <div class="text-center overflow-hidden">
                                <div id="recipient-name" class="font-black text-[9px] uppercase text-slate-800 truncate px-2 group-hover:text-blue-600 transition-colors">Pilih Data</div>
                                <div id="current-info" class="text-[8px] opacity-40 font-black mt-1 text-center">0/0</div>
                            </div>
                            <button onclick="nextRecipient()" class="p-2 bg-white rounded-lg shadow-sm text-slate-400 hover:text-blue-600 hover:bg-blue-50 font-bold active:scale-90 transition-all text-left"></button>
                        </div>
                    </div>
                    
                    <!-- COLLAPSIBLE SETTINGS -->
                    <div class="border-b border-slate-50 pb-4">
                        <button onclick="toggleSettings()" class="w-full flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-all hover:scale-[1.02]">
                            <span class="text-blue-600 text-[10px] font-black uppercase tracking-widest">Pengaturan Dokumen</span>
                            <span id="settings-arrow" class="transition-transform duration-300"></span>
                        </button>
                        
                        <div id="settings-content" class="hidden space-y-6 pt-6">
                            <div class="text-left border-b border-slate-100 pb-6">
                                <label class="text-slate-400 text-[10px] font-black uppercase mb-2">Logo Daerah</label>
                                <input type="file" accept="image/*" onchange="window.handleLogoUpload(event)" class="text-[8px] text-slate-400 file:mr-2 file:py-1.5 file:px-2 file:rounded file:border-0 file:text-[9px] file:font-black file:bg-blue-50 file:text-blue-700 cursor-pointer w-full hover:file:bg-blue-100">
                            </div>

                            <div class="text-left">
                                <label class="text-slate-400 text-[10px] font-black uppercase mb-2">Sistem Tanda Tangan</label>
                                <div class="flex flex-col gap-4">
                                    <div class="flex gap-1 p-1 bg-slate-100 rounded-lg">
                                        <button id="btn-sig-manual" onclick="setSignatureMode('manual')" class="flex-1 py-2 text-[8px] font-black uppercase rounded-md transition-all">Manual</button>
                                        <button id="btn-sig-digital" onclick="setSignatureMode('digital')" class="flex-1 py-2 text-[8px] font-black uppercase rounded-md transition-all">Digital</button>
                                    </div>
                                    <div id="sig-upload-block" class="space-y-4">
                                        <div>
                                            <label class="text-[9px] mb-1 text-blue-500 font-bold">Unggah TTD (PNG Transparan)</label>
                                            <input type="file" accept="image/*" onchange="window.handleSignatureUpload(event)" class="text-[8px] text-slate-400 file:mr-2 file:py-1.5 file:px-2 file:rounded file:border-0 file:text-[9px] file:font-black file:bg-blue-50 file:text-blue-700 cursor-pointer w-full hover:file:bg-blue-100">
                                        </div>
                                        <div id="sig-nudge-block" class="grid grid-cols-1 gap-4 bg-slate-50 p-3 rounded-xl">
                                            <div class="space-y-1">
                                                <label class="text-[8px] flex justify-between"><span>Geser Horisontal (X)</span><span id="label-x" class="font-bold text-blue-500">0</span></label>
                                                <input type="range" min="-100" max="100" value="0" oninput="document.getElementById('label-x').textContent=this.value; window.updateSigOffset('x', this.value)" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-blue-100">
                                            </div>
                                            <div class="space-y-1">
                                                <label class="text-[8px] flex justify-between"><span>Geser Vertikal (Y)</span><span id="label-y" class="font-bold text-blue-500">0</span></label>
                                                <input type="range" min="-150" max="150" value="0" oninput="document.getElementById('label-y').textContent=this.value; window.updateSigOffset('y', this.value)" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-blue-100">
                                            </div>
                                            <div class="space-y-1">
                                                <label class="text-[8px] flex justify-between"><span>Ukuran Tanda Tangan</span><span id="label-scale" class="font-bold text-blue-500">100%</span></label>
                                                <input type="range" min="0.3" max="2.5" step="0.05" value="1" oninput="document.getElementById('label-scale').textContent=Math.round(this.value*100)+'%'; window.updateSigScale(this.value)" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-blue-100">
                                            </div>
                                            <div class="space-y-1">
                                                <label class="text-[8px] flex justify-between"><span>Kemiringan TTD</span><span id="label-rotate" class="font-bold text-blue-500">0</span></label>
                                                <input type="range" min="-45" max="45" value="0" oninput="document.getElementById('label-rotate').textContent=this.value+''; window.updateSigRotate(this.value)" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-blue-100">
                                            </div>
                                        </div>
                                        <button onclick="deleteSignature()" class="w-full py-2 bg-red-50 text-red-500 rounded-lg text-[8px] font-black uppercase hover:bg-red-500 hover:text-white transition-all">Hapus TTD Cloud</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4 text-left">
                        <button onclick="window.printDoc()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-xl hover:bg-black hover:scale-[1.03] active:scale-95 transition-all text-center">Cetak Berkas</button>
                    </div>
                </aside>
                <div class="flex-grow bg-slate-200 rounded-3xl shadow-inner border border-slate-300/50 overflow-auto flex flex-col items-center py-12 scrollbar-hide text-left hover:border-slate-400/50 transition-colors">
                    <div id="merge-result-preview" class="transform scale-[0.5] sm:scale-[0.7] md:scale-[0.8] lg:scale-[0.95] origin-top bg-white hover:scale-[0.97] transition-transform duration-500"></div>
                </div>
            </div>
        </section>

        <section id="admin" class="tab-content hidden py-20 text-center">
            <div class="w-full max-w-md mx-auto bg-white p-12 rounded-2xl shadow-2xl border border-slate-100 space-y-10 text-center hover:shadow-blue-100 transition-shadow duration-500">
                <div class="bg-blue-50 text-blue-600 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto shadow-inner text-center"><svg class="w-10 h-10 text-center" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
                <h3 class="text-3xl font-black text-slate-900 uppercase leading-tight text-center">Administrator</h3>
                <form onsubmit="window.loginAdmin(event)" class="space-y-6 text-center">
                    <input type="password" id="admin-password" required class="w-full px-8 py-5 bg-slate-50 rounded-xl border-none outline-none font-mono text-center shadow-inner tracking-[0.5em] text-center focus:bg-white transition-colors" placeholder="">
                    <div class="flex items-center gap-2 px-2 text-left">
                        <input type="checkbox" id="admin-remember" class="w-4 h-4 rounded border-slate-300 text-blue-600 text-left">
                        <label for="admin-remember" class="text-[10px] text-slate-500 mb-0 font-bold uppercase tracking-wide text-left cursor-pointer hover:text-blue-600">Ingat Sesi Saya</label>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-black py-5 rounded-xl shadow-2xl uppercase tracking-widest text-[11px] hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all text-center">Masuk ke Sistem</button>
                </form>
                
                <button onclick="window.logoutAdmin()" class="mt-10 text-red-400 font-black text-[10px] uppercase tracking-widest hover:text-red-600 hover:scale-110 transition-all text-center">Logout</button>
            </div>
        </section>
    </main>

    <!-- MODAL EDIT -->
    <div id="modal-edit-pindah" class="fixed inset-0 z-[150] hidden items-center justify-center p-4">
        <div class="absolute inset-0 modal-overlay" onclick="window.toggleModal('modal-edit-pindah')"></div>
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh] text-left">
            <div class="bg-slate-900 px-10 py-6 flex justify-between items-center shrink-0">
                <h2 class="text-white font-black text-lg uppercase tracking-tight text-left">Update Berkas Mutasi Master</h2>
                <button onclick="window.toggleModal('modal-edit-pindah')" class="text-slate-400 hover:text-white hover:scale-125 transition-transform"></button>
            </div>
            
            <form id="form-edit-pindah" onsubmit="window.handleProcessData(event, 'update', this.dataset.docId)" class="flex-grow flex flex-col overflow-hidden">
                <div id="edit-form-container" class="flex-grow overflow-y-auto p-12 bg-white space-y-12 text-left">
                </div>
                
                <div class="shrink-0 flex gap-4 p-8 border-t bg-slate-50 text-left">
                    <button type="submit" class="flex-grow bg-slate-900 text-white font-black py-5 rounded-xl uppercase tracking-widest text-xs shadow-xl hover:bg-black transition-all text-center">Update Cloud Database</button>
                    <button type="button" onclick="window.toggleModal('modal-edit-pindah')" class="px-10 bg-slate-200 text-slate-500 font-bold py-5 rounded-xl uppercase text-[10px] hover:bg-slate-300 transition-all text-center">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="mt-20 py-16 border-t bg-white text-center text-[12px] text-blue-800 font-black uppercase tracking-[0.1em] no-print px-10">
        EDI BRATA &copy; 2026 | MASTER S-12 & S-13 SYSTEM | DEVELOPED BY EDI BRATA
    </footer>
</body>
</html>
